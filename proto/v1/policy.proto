// SPDX-License-Identifier: GPL-3.0-or-later
syntax = "proto3";

package phantomdns.dataplane.v1;

option go_package = "github.com/lopster568/phantomDNS/internal/pb/dataplane/v1;datapv1";
option java_multiple_files = true;
option java_package = "com.phantomdns.dataplane.v1";
option csharp_namespace = "PhantomDNS.DataPlane.V1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "proto/v1/common.proto";

// ============================================================================
// Policy Service
// ============================================================================

service PolicyService {
  // Retrieve all active policies with pagination
  rpc GetPolicies(GetPoliciesRequest) returns (GetPoliciesResponse);
  
  // Retrieve a specific policy by ID
  rpc GetPolicyByID(GetPolicyByIDRequest) returns (Policy);
  
  // Create a new policy
  rpc CreatePolicy(CreatePolicyRequest) returns (Policy);
  
  // Update an existing policy
  rpc UpdatePolicy(UpdatePolicyRequest) returns (Policy);
  
  // Delete a policy
  rpc DeletePolicy(DeletePolicyRequest) returns (google.protobuf.Empty);
  
  // Reload all policies in the dataplane
  rpc ReloadPolicies(google.protobuf.Empty) returns (ReloadPoliciesResponse);
  
  // Stream policy updates for real-time synchronization
  rpc WatchPolicies(google.protobuf.Empty) returns (stream PolicyUpdate);
  
  // Get policy statistics
  rpc GetPolicyStats(google.protobuf.Empty) returns (PolicyStats);
  
  // Validate a policy before creation/update
  rpc ValidatePolicy(ValidatePolicyRequest) returns (ValidatePolicyResponse);
}

// Policy action types
enum PolicyAction {
  ACTION_UNKNOWN = 0;
  ALLOW = 1;
  BLOCK = 2;
  REDIRECT = 3;
  LOG = 4;
}

// Policy match conditions
enum MatchCondition {
  CONDITION_UNKNOWN = 0;
  DOMAIN_EXACT = 1;
  DOMAIN_WILDCARD = 2;
  REGEX = 3;
  CIDR = 4;
}

// Policy priority level
enum PolicyPriority {
  PRIORITY_UNKNOWN = 0;
  LOW = 1;
  MEDIUM = 2;
  HIGH = 3;
  CRITICAL = 4;
}

// Policy rule for matching DNS queries
message PolicyRule {
  string id = 1;
  string name = 2;
  MatchCondition condition = 3;
  string pattern = 4;
  string description = 5;
  map<string, string> metadata = 6;
}

// Policy action configuration
message PolicyActionConfig {
  PolicyAction action = 1;
  string target = 2; // IP address for redirect, log level for LOG, etc.
  map<string, string> options = 3;
}

// Policy definition
message Policy {
  string id = 1;
  string name = 2;
  string description = 3;
  
  // Rules that trigger this policy
  repeated PolicyRule rules = 4;
  
  // Actions to take when rules match
  repeated PolicyActionConfig actions = 5;
  
  // Priority level for conflict resolution
  PolicyPriority priority = 6;
  
  // Enable/disable policy
  bool enabled = 7;
  
  // Scope/target for this policy
  string scope = 8; // e.g., "global", "user:123", "network:192.168.1.0/24"
  
  // Metadata and labels
  map<string, string> labels = 9;
  
  // Timestamps and audit info
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
  string created_by = 12;
  string updated_by = 13;
  
  // Policy version for conflict resolution
  int32 version = 14;
}

// Request to get policies with pagination
message GetPoliciesRequest {
  PaginationRequest pagination = 1;
  bool enabled_only = 2;
  PolicyPriority min_priority = 3;
  string scope_filter = 4;
}

// Response containing policies
message GetPoliciesResponse {
  repeated Policy policies = 1;
  PaginationMetadata pagination = 2;
}

// Request to get a specific policy
message GetPolicyByIDRequest {
  string policy_id = 1;
}

// Request to create a policy
message CreatePolicyRequest {
  string name = 1;
  string description = 2;
  repeated PolicyRule rules = 3;
  repeated PolicyActionConfig actions = 4;
  PolicyPriority priority = 5;
  string scope = 6;
  map<string, string> labels = 7;
  string created_by = 8;
}

// Request to update a policy
message UpdatePolicyRequest {
  string policy_id = 1;
  string name = 2;
  string description = 3;
  repeated PolicyRule rules = 4;
  repeated PolicyActionConfig actions = 5;
  PolicyPriority priority = 6;
  string scope = 7;
  map<string, string> labels = 8;
  bool enabled = 9;
  int32 version = 10; // For optimistic locking
  string updated_by = 11;
}

// Request to delete a policy
message DeletePolicyRequest {
  string policy_id = 1;
  bool cascade = 2; // Delete associated rules and conditions
  string deleted_by = 3;
}

// Response for reload policies operation
message ReloadPoliciesResponse {
  int32 policies_loaded = 1;
  int32 policies_failed = 2;
  repeated string errors = 3;
  google.protobuf.Timestamp reload_timestamp = 4;
}

// Policy update stream message
message PolicyUpdate {
  enum UpdateType {
    UNKNOWN = 0;
    CREATED = 1;
    UPDATED = 2;
    DELETED = 3;
    RELOADED = 4;
  }
  UpdateType type = 1;
  Policy policy = 2;
  google.protobuf.Timestamp timestamp = 3;
  string triggered_by = 4;
}

// Policy statistics
message PolicyStats {
  int32 total_policies = 1;
  int32 enabled_policies = 2;
  int32 disabled_policies = 3;
  map<string, int32> policies_by_priority = 4;
  map<string, int32> policies_by_action = 5;
  int64 total_matches = 6;
  map<string, int64> matches_by_action = 7;
  google.protobuf.Timestamp last_reload = 8;
}

// Request to validate a policy
message ValidatePolicyRequest {
  string name = 1;
  repeated PolicyRule rules = 2;
  repeated PolicyActionConfig actions = 3;
}

// Response for policy validation
message ValidatePolicyResponse {
  bool is_valid = 1;
  repeated string validation_errors = 2;
  repeated string warnings = 3;
}
